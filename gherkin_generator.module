<?php
/**
 * @file
 * Code for the gherkin_generator feature.
 */

include_once 'gherkin_generator.features.inc';

function gherkin_generator_permission() {
    return array(
        'run gherkin test' =>  array(
            'title' => t('Allowed to run a gherkin test'),
        ),
    );
}

function gherkin_generator_theme(){
    return array(
        'gherkin_results_area' => array(
            'variables' => array(
                'params' => NULL
            ),
            'template' => 'tpl/gherkin-results-area'
        ),
        'gherkin_questions_area' => array(
            'variables' => array(
                'params' => NULL
            ),
            'template' => 'tpl/gherkin-questions-area'
        )
    );
}


function gherkin_generator_page_alter(&$page) {

    if(arg(2) == 'gherkin-generator' && arg(1) == 'add') {

        $page['content']['system_main']['#attributes']['class'][] = 'span6';
        $page['content']['test_results']['#theme'] = 'gherkin_results_area';
    }
}


function gherkin_generator_menu() {
    $items['admin/gherkin_generator/run'] = array(
        'page callback' => array('gherkin_generator_run'),
        'file' => 'inc/gherkin_generator_run.inc',
        'access arguments' => array('run gherkin test'),
        'type' => MENU_CALLBACK
    );
    $items['admin/gherkin_generator/save'] = array(
        'page callback' => array('gherkin_generator_save'),
        'file' => 'inc/gherkin_generator_save.inc',
        'access arguments' => array('run gherkin test'),
        'type' => MENU_CALLBACK
    );
    return $items;
}

function gherkin_generator_form_alter(&$form) {
    if($form['#form_id'] == 'gherkin_generator_node_form') {
        /**
         * Add CSS / and JS Attributes to form
         */
        $path = drupal_get_path('module', 'gherkin_generator');
        //dpm($form);

        //$form['#attributes']['class'][] = 'form-horizontal';
        $form['#attached']['css']['gherkin_generator'] = $path . '/css/gherkin_edit.css';
        $form['#attached']['js']['gherkin_generator_edit'] = $path . '/js/gherkin_edit.js';
        $form['#attached']['js']['gherkin_generator_run'] = $path . '/js/gherkin_run.js';
        $form['#attached']['js']['gherkin_generator_run'] = $path . '/js/gherkin_save.js';
        drupal_add_library('system', 'ui.sortable');

        $filename = REQUEST_TIME;

        $form['title'] = array(
            '#type' => 'hidden',
            '#value' => $filename
        );

        $form['actions']['#attributes'] = array('class' => array('hidden'));
        $form['additional_settings']['#type'] = 'fieldset';
        $form['additional_settings']['#attributes'] = array('class' => array('hidden'));

        $form['existing_test'] = array(
            '#type' => 'container',
            '#attributes' => array('class' => array('well'), 'id' => 'existing-test'),
            '#weight' => -101,
        );

        $form['existing_test']['intro'] = array(
            '#markup' => "This is a tool to help to generate
                <a href=\"https://github.com/cucumber/cucumber/wiki/Gherkin\" target='_blank'>Gherkin</a>,
                a language to aid in software development and testing. The idea came from <a href=\"http://wauat.com/\" target='_blank'>Murrion Sofware</a>.
                <br> Just <a href='#' class='btn btn-small btn-info example-test-load'>click here</a> to load an example test.
                <hr>"
        );

        $form['existing_test']['build'] = array(
            '#theme' => 'gherkin_questions_area'
        );


        $form['existing_test']['actions'] = array(
            '#type' => 'container',
            '#attributes' => array('class' => array('actions')),
        );


        $form['existing_test']['actions']['run_test'] = array(
            '#type' => 'button',
            '#name' => 'run_test',
            '#value' => t('Run Test'),
            '#attributes' => array('class' => array('btn-success', 'disabled')),
        );

        $form['existing_test']['actions']['save_test'] = array(
            '#type' => 'button',
            '#name' => 'save_test',
            '#value' => 'Save Test',
            '#attributes' => array('class' => array('btn-info', 'disabled')),
        );

        $form['existing_test']['actions']['start_over'] = array(
            '#type' => 'button',
            '#name' => 'start_over',
            '#value' => t('Start Over'),
            '#attributes' => array('class' => array('btn-danger', 'disabled')),
        );


        $form['questions'] = array(
            '#type' => 'container',
            '#attributes' => array('class' => array('well')),
            '#weight' => -100
        );


        $form['questions']['test_name']['name'] = array(
            '#type' => 'textfield',
            '#title' => t('What do you want to call this test?'),
            '#attributes' => array('class' => array('span12'), 'placeholder' =>  t('A simple descriptive name of the test')),

        );

        $form['questions']['test_name']['name_button'] = array(
            '#type' => 'button',
            '#value' => t('Name it'),
            '#attributes' => array(
                'data-method' => array('replaceWith'),
                'data-test-message' => array('Scenario'),
                'data-parent-input' => array('name'),
                'class' => array('steps')
             ),
            '#suffix' => '<hr>'
        );


        $form['questions']['when_i_go_to']['url'] = array(
            '#type' => 'textfield',
            '#title' => t('When I go to'),
            '#name' => 'url',
            '#attributes' => array('class' => array('span12'), 'placeholder' =>  t('a full website address')),
        );

        $form['questions']['when_i_go_to']['url_button'] = array(
            '#type' => 'button',
            '#name' => 'go_to',
            '#value' => t('Add'),
            '#attributes' => array(
                'data-method' => array('replaceWith'),
                'data-test-message' => array('Given I am on'),
                'data-parent-input' => array('url'),
                'class' => array('steps')
            ),
            '#suffix' => '<hr>'
        );


        $form['questions']['and_i_fill_in']['form_field_name'] = array(
            '#type' => 'textfield',
            '#title' => t('And I fill in'),
            '#name' => 'form_field_and_fill_in',
            '#attributes' => array('class' => array('span12'), 'placeholder' =>  t('a form field name')),
        );

        $form['questions']['and_i_fill_in']['with'] = array(
            '#markup' => 'with',
            '#prefix' => '<div class="qualifier">',
            '#suffix' => '</div>',
        );

        $form['questions']['and_i_fill_in']['field_text'] = array(
            '#type' => 'textfield',
            '#name' => 'field_with_text',
            '#attributes' => array('class' => array('span12'), 'placeholder' =>  t('with the following text field')),
        );

        $form['questions']['and_i_fill_in']['field_text_button'] = array(
            '#type' => 'button',
            '#name' => 'field_text_add',
            '#value' => t('Add'),
            '#attributes' => array(
                'data-method' => array('append'),
                'data-test-message' => array('And I fill in'),
                'data-parent-input' => array('form_field_and_fill_in'),
                'data-value-2' => array('field_with_text'),
                'data-middle-words' => array('with'),
                'class' => array('steps')
            ),
            '#suffix' => '<hr>'
        );


        $form['questions']['and_i_click_on_a']['click_on_type'] = array(
            '#type' => 'select',
            '#name' => 'click_on_type',
            '#title' => t('And I click on a'),
            '#options' => array('follow' => t('link'), 'press' => t('button')),
            '#validated' => TRUE
        );

        $form['questions']['and_i_click_on_a']['called'] = array(
            '#prefix' => '<div class="qualifier">',
            '#suffix' => '</div>',
            '#markup' => 'called',
        );

        $form['questions']['and_i_click_on_a']['field_text'] = array(
            '#type' => 'textfield',
            '#name' => 'click_on_text',
            '#attributes' => array('class' => array('span12'), 'placeholder' =>  t('enter a link of button name here'))
        );

        $form['questions']['and_i_click_on_a']['click_on_a'] = array(
            '#type' => 'button',
            '#name' => 'click_on_a',
            '#value' => t('Add'),
            '#attributes' => array(
                'data-method' => array('append'),
                'data-element-type' => array('select'),
                'data-target' => array('click_on'),
                'data-test-message' => array('And I'),
                'data-parent-input' => array('click_on_type'),
                'data-value-2' => array('click_on_text'),
                'class' => array('steps')
            ),
            '#suffix' => '<hr>'
        );

        $form['questions']['then_i_should_see']['click_on_type'] = array(
            '#type' => 'select',
            '#name' => 'should_see',
            '#prefix' => '<div class="qualifier">',
            '#suffix' => '</div>',
            '#title' => t('Then I should see'),
            '#options' => array('should see' => t('see'), 'should not see' => t('not see')),
            '#validated' => TRUE
        );

        $form['questions']['then_i_should_see']['see_not_see_some_text'] = array(
            '#type' => 'textfield',
            '#name' => 'see_not_see_some_text',
            '#attributes' => array('class' => array('span12'), 'placeholder' =>  t('some text on that page'))
        );

        $form['questions']['then_i_should_see']['see_not_see'] = array(
            '#type' => 'button',
            '#name' => 'see_not_see',
            '#value' => t('Add'),
            '#attributes' => array(
                'data-method' => array('append'),
                'data-target' => array('see'),
                'data-element-type' => array('select'),
                'data-test-message' => array('Then I'),
                'data-parent-input' => array('should_see'),
                'data-value-2' => array('see_not_see_some_text'),
                'class' => array('steps')
            ),
            '#suffix' => '<hr>'
        );

        $form['filename'] = array(
            '#type' => 'hidden',
            '#name' => 'filename',
            '#value' => $filename,
        );
    }
}


function _gherkin_generator_save_to_file($request) {
    $feature = _gherkin_generator_parse_questions($request['scenario']);
    $filename = $request['filename'];
    $path = file_build_uri("/gherkin_tests/");

    if (!file_prepare_directory($path, FILE_CREATE_DIRECTORY)) {
        drupal_mkdir($path);
    }

    $response = file_unmanaged_save_data($feature, $path . '/' . $filename . '.feature', $replace = FILE_EXISTS_REPLACE);
    $file_url = l('click here', file_create_url($response), array('attributes' => array('target' => '_blank')));

    if($response == FALSE) {
        watchdog('gherkin_generator', "File could not be made.", $variables = array(), $severity = WATCHDOG_ERROR, $link = NULL);
        return array('message' => "Error file could not be save", 'file' => $response, 'error' => '1');
    } else {
        $date = format_date(time(), $type = 'medium', $format = '', $timezone = NULL, $langcode = NULL);
        watchdog('gherkin_generator', "%date File made %name", $variables = array('%date' => $date, '%name' => $response), $severity = WATCHDOG_NOTICE, $link = $file_url);
        return array('message' => t('@date: <br> File created !name to download ', array('@date' => $date, '!name' => $file_url)), 'file' => $response, 'error' => '0');
    }
}

function _gherkin_generator_parse_questions($scenario) {
    $final_output = '';
    $count = 0;
    foreach($scenario as $value) {
        if($count == 1) {
            $indent = '  ';
        } elseif($count > 1) {
            $indent = '    ';
        } else {
            $indent = '';
        }
        $final_output = $final_output .  $indent . $value . " \r\n";
        $count ++;
    }
    return $final_output;
}

